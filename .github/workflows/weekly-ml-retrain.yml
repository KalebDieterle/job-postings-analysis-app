name: Weekly ML Model Retraining

on:
  schedule:
    # Run every Sunday at 6:00 AM UTC (after daily imports)
    - cron: "0 6 * * 0"

  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ml-retrain
  cancel-in-progress: false

jobs:
  retrain-and-deploy:
    name: Train ML Models & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: ml-service/requirements.txt

      - name: Install dependencies
        working-directory: ml-service
        run: pip install -r requirements.txt

      - name: Train all models
        working-directory: ml-service/training
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          MODEL_DIR: ../models
        run: |
          echo "::add-mask::$DATABASE_URL"
          echo "Starting training at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          python train_all.py

      - name: Verify model artifacts
        working-directory: ml-service
        run: |
          echo "Model artifacts:"
          ls -la models/
          # Check that critical files exist
          test -f models/salary_median.lgb || (echo "Missing salary_median.lgb" && exit 1)
          test -f models/salary_encoders.joblib || (echo "Missing salary_encoders.joblib" && exit 1)

      - name: Deploy to Fly.io
        if: success()
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Fly deploy
        if: success()
        working-directory: ml-service
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          if [ -n "$FLY_API_TOKEN" ]; then
            flyctl deploy --remote-only
          else
            echo "FLY_API_TOKEN not set â€” skipping deployment"
          fi

      - name: Training summary
        if: always()
        run: |
          echo "Retraining completed at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
